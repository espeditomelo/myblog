<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">

<body>
<div layout:fragment="content">

        <section>

            <div class="container" style="width: 60%; padding-bottom: 30 px;">

                <span th:if="${selectedCategory != null}">
                    <nav aria-label="breadcrumb">
                       <ol class="breadcrumb" style="backgound-color: white; padding-left: 0px">
                           <li class="breadcumb-item active" aria-current="page">
                               <h2 th:text="${selectedCategory.name}"></h2>
                           </li>
                       </ol>
                    </nav>
                </span>

                <!-- Toast de sucesso -->
                <div th:if="${success}" id="successToast" class="toast bg-success text-white" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header bg-success text-white">
                        <strong class="mr-auto">Sucesso!</strong>
                        <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="toast-body">
                        <span th:text="${success}"></span>
                    </div>
                </div>

                <article>

                    <div th:if="${post.mainImageUrl != null}" style="margin-bottom: 30px; text-align: center;">
                        <img th:src="${post.mainImageUrl}" alt="Post image" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    </div>

                    <h2 class="card-title" style="font-weight: bold; color=blue; padding-top: 5px;">
                        <span th:text="${post.title}"></span>
                    </h2>

                    <p class="card-subtitle mb-2 text-muted" style="font-size: 0.8rem;">
                        <span th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy')}"></span> - by
                        <a th:href="@{/postsbyuser/{id}(id=${post.user.id})}">
                            <span th:text="${post.user.username}"></span>
                        </a>
                    </p>

                    <section>
                        <p class="card-text" style="margin-top: 40px;"><span th:utext="${post.body}"></span></p>
                    </section>


                    <!--comments-->
                    <div class="card shadow-sm bg-white rounded" style="margin-top: 20px;" th:if="${not #lists.isEmpty(comments)}">
                        <div class="card-body">

                            <h2 class="card-title" style="font-weight: normal; color=blue; padding-top: 5px;">
                                Comments
                            </h2>

                            <div class="mt-4">

                                <div th:replace="~{fragments/comment-thread :: commentThread(${comments})}"></div>

                            </div>

                        </div>
                    </div>



                    <!--leave a comment-->
                    <div id="global-comment-card" class="card shadow-sm bg-white rounded" style="margin-top: 20px;">
                        <div class="card-body">

                            <h2 class="card-title" style="font-weight: normal; color=blue; padding-top: 5px;">
                                Leave Your Comment
                            </h2>
                            <form id="global-comment-form" th:action="@{'/posts/' + ${post.id} + '/comments'}" method="post" th:object="${comment}">

                                <div class="form-group">
                                    <label for="contentComment">Comment</label>
                                    <textarea class="form-control" id="contentComment" th:field="*{content}" placeholder="Your comment *" required></textarea>
                                </div>

                                <div class="form-group">
                                    <label for="usernameComment">Username</label>
                                    <input type="text" class="form-control" id="usernameComment" th:field="*{username}" placeholder="Your username *" required>
                                </div>

                                <div class="form-group">
                                    <label for="emailComment">E-mail</label>
                                    <input type="email" class="form-control" id="emailComment" th:field="*{email}" placeholder="Your e-mail *" required>
                                </div>

                                <small class="form-text text-muted">(*) Required</small>
                                <button type="submit" class="btn btn-primary" role="button" style="margin-top: 10px;">Post Your Comment</button>
                            </form>
                        </div>
                    </div>

                </article>

            </div>

        </section>

</div>

    <!-- Scripts específicos desta página - APÓS o fragment content -->
<th:block layout:fragment="scripts">
    <script>
        $(document).ready(function () {
            // Toast (sem alterações)
            const $toast = $('#successToast');
            if ($toast.length) {
                $toast.toast({ delay: 4000 });
                $toast.toast('show');
            }

            // --- NOVO: eventos de reply com delegação ---
            $(document).on('click', '.reply-btn', function () {
                const commentId = $(this).data('comment-id');
                const replyForm = $('#reply-form-' + commentId);

                // Oculta o formulário global
                $('#global-comment-card').slideUp();

                // Oculta todos os outros formulários de reply
                $('.reply-form').hide();

                // Mostra o formulário específico
                replyForm.slideDown();
            });

            $(document).on('click', '.cancel-reply', function () {
                const commentId = $(this).data('comment-id');
                $('#reply-form-' + commentId).slideUp();

                // Reexibe o formulário global
                $('#global-comment-card').slideDown();
            });
        });
    </script>
</th:block>


</body>
</html>